-- Create database
CREATE DATABASE cricket_analytics;

-- Use the database
\c cricket_analytics;

-- Teams table
CREATE TABLE teams (
    team_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    country VARCHAR(50),
    founded_year INTEGER,
    captain VARCHAR(100),
    coach VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Players table
CREATE TABLE players (
    player_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    team_id INTEGER REFERENCES teams(team_id),
    position VARCHAR(50),
    batting_style VARCHAR(20),
    bowling_style VARCHAR(30),
    nationality VARCHAR(50),
    birth_date DATE,
    debut_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Matches table
CREATE TABLE matches (
    match_id SERIAL PRIMARY KEY,
    external_match_id VARCHAR(50) UNIQUE,
    team1_id INTEGER REFERENCES teams(team_id),
    team2_id INTEGER REFERENCES teams(team_id),
    match_date TIMESTAMP,
    venue VARCHAR(200),
    match_type VARCHAR(20) CHECK (match_type IN ('Test', 'ODI', 'T20', 'IPL')),
    status VARCHAR(20) DEFAULT 'upcoming',
    winner_team_id INTEGER REFERENCES teams(team_id),
    toss_winner_team_id INTEGER REFERENCES teams(team_id),
    toss_decision VARCHAR(10),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Match scores table
CREATE TABLE match_scores (
    score_id SERIAL PRIMARY KEY,
    match_id INTEGER REFERENCES matches(match_id) ON DELETE CASCADE,
    team_id INTEGER REFERENCES teams(team_id),
    innings_number INTEGER,
    total_runs INTEGER,
    total_wickets INTEGER,
    total_overs DECIMAL(4,1),
    run_rate DECIMAL(4,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Player statistics table
CREATE TABLE player_stats (
    stat_id SERIAL PRIMARY KEY,
    player_id INTEGER REFERENCES players(player_id) ON DELETE CASCADE,
    match_id INTEGER REFERENCES matches(match_id) ON DELETE CASCADE,
    runs_scored INTEGER DEFAULT 0,
    balls_faced INTEGER DEFAULT 0,
    fours INTEGER DEFAULT 0,
    sixes INTEGER DEFAULT 0,
    strike_rate DECIMAL(5,2),
    wickets_taken INTEGER DEFAULT 0,
    overs_bowled DECIMAL(4,1) DEFAULT 0,
    runs_conceded INTEGER DEFAULT 0,
    economy_rate DECIMAL(4,2),
    catches INTEGER DEFAULT 0,
    stumpings INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Ball-by-ball data table
CREATE TABLE ball_by_ball (
    ball_id SERIAL PRIMARY KEY,
    match_id INTEGER REFERENCES matches(match_id) ON DELETE CASCADE,
    innings_number INTEGER,
    over_number INTEGER,
    ball_number INTEGER,
    batsman_id INTEGER REFERENCES players(player_id),
    bowler_id INTEGER REFERENCES players(player_id),
    runs_scored INTEGER,
    extras INTEGER DEFAULT 0,
    wicket_type VARCHAR(20),
    wicket_player_id INTEGER REFERENCES players(player_id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for better performance
CREATE INDEX idx_matches_date ON matches(match_date);
CREATE INDEX idx_matches_status ON matches(status);
CREATE INDEX idx_player_stats_player ON player_stats(player_id);
CREATE INDEX idx_player_stats_match ON player_stats(match_id);
CREATE INDEX idx_ball_match ON ball_by_ball(match_id);